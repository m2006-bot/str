<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>iPhone Focus Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        :root {
            --bg-gradient: linear-gradient(180deg, #f5f7fa 0%, #c3cfe2 100%);
            --text-primary: #1d1d1f;
            --sheet-bg: rgba(255, 255, 255, 0.8);
            --accent: #007aff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-gradient: linear-gradient(180deg, #1c1c1e 0%, #000000 100%);
                --text-primary: #ffffff;
                --sheet-bg: rgba(30, 30, 34, 0.9);
            }
        }

        body { height: 100vh; background: var(--bg-gradient); color: var(--text-primary); display: flex; justify-content: center; align-items: center; overflow: hidden; }
        
        /* بنر التثبيت بتصميم iOS */
        #install-banner {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--sheet-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 15px; border-radius: 20px; display: none;
            justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000;
            border: 0.5px solid rgba(255,255,255,0.2);
        }

        .container { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: space-around; align-items: center; padding: 40px 20px; text-align: center; 
        }

        .quote-container { max-width: 80%; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        #quote-text { font-size: 16px; font-weight: 300; font-style: italic; opacity: 0.7; line-height: 1.5; }

        .timer-display { font-size: clamp(80px, 22vw, 150px); font-weight: 200; letter-spacing: -4px; font-variant-numeric: tabular-nums; margin: 20px 0; }
        
        .controls { width: 100%; max-width: 450px; display: flex; justify-content: space-around; align-items: center; }
        .btn { border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.9); }
        .circle { width: 75px; height: 75px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        svg { width: 30px; height: 30px; fill: white; }
        
        .green { background-color: #34c759; } .red { background-color: #ff3b30; } .gray { background-color: #8e8e93; } .blue { background-color: #007aff; }
        .label { font-size: 13px; font-weight: 500; opacity: 0.5; }

        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 99; }
        .sheet { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: var(--sheet-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-radius: 35px 35px 0 0; padding: 30px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; border-top: 1px solid rgba(255,255,255,0.1); }
        .sheet.active { bottom: 0; }
        .history-item { display: flex; justify-content: space-between; padding: 18px 0; border-bottom: 0.5px solid rgba(150,150,150,0.2); font-size: 17px; }
    </style>
</head>
<body>

    <div id="install-banner">
        <span style="font-size: 14px; font-weight: 500;">تثبيت تطبيق الدراسة على الشاشة؟</span>
        <button onclick="installApp()" style="background:var(--accent); color:white; border:none; padding:8px 18px; border-radius:12px; font-weight:600;">تثبيت</button>
    </div>

    <div class="container">
        <div class="quote-container">
            <p id="quote-text">"انطلق الآن، فالمستقبل يُصنع اللحظة."</p>
        </div>

        <div class="timer-display" id="display">00:00:00</div>
        
        <div class="controls">
            <button class="btn" onclick="resetTimer()">
                <div class="circle gray"><svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div>
                <span class="label">تصفير</span>
            </button>
            <button class="btn" id="startBtn" onclick="startTimer()">
                <div class="circle green"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                <span class="label">بدء</span>
            </button>
            <button class="btn" id="stopBtn" style="display:none" onclick="stopTimer()">
                <div class="circle red"><svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></div>
                <span class="label">إيقاف</span>
            </button>
            <button class="btn" onclick="toggleSheet(true)">
                <div class="circle blue"><svg viewBox="0 0 24 24"><path d="M10 20h4V4h-4v16zm-6 0h4v-8H4v8zM16 9v11h4V9h-4z"/></svg></div>
                <span class="label">السجل</span>
            </button>
        </div>
    </div>

    <div class="sheet-overlay" id="overlay" onclick="toggleSheet(false)"></div>
    <div class="sheet" id="sheet">
        <div style="width:40px; height:5px; background:rgba(150,150,150,0.5); border-radius:10px; margin: 0 auto 25px;"></div>
        <h2 style="font-weight: 700; margin-bottom: 20px;">إحصائيات الدراسة</h2>
        <div id="logsList" style="overflow-y:auto; height:70%;"></div>
        <button onclick="toggleSheet(false)" style="width:100%; padding:18px; border-radius:18px; border:none; background:#007aff; color:white; font-size:17px; font-weight:600; margin-top:20px;">تم</button>
    </div>

    <script>
        // --- تسجيل الـ Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed'));
            });
        }

        // --- منطق زر التثبيت ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-banner').style.display = 'flex';
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('install-banner').style.display = 'none';
            }
        }

        // --- منطق العداد والعبارات ---
        const quotes = [
            "النجاح ليس صدفة، بل هو عمل شاق واستمرار.", "تعب اليوم هو راحة الغد.", "كل ساعة تدرسها الآن تقربك من حلمك خطوة.",
            "أنت أقوى مما تعتقد، وأذكى مما تظن.", "العظمة تبدأ بقرار صغير: سأبدأ الآن."
            // ... يمكنك إضافة باقي العبارات هنا ...
        ];

        function setQuote() {
            const index = Math.floor(Date.now() / 3600000) % quotes.length;
            document.getElementById('quote-text').innerText = `"${quotes[index]}"`;
        }

        const TIME_KEY = 'study_ms_v6';
        const RUNNING_KEY = 'study_running_v6';
        const HISTORY_KEY = 'study_history_v6';

        let elapsedTime = parseInt(localStorage.getItem(TIME_KEY)) || 0;
        let isRunning = localStorage.getItem(RUNNING_KEY) === 'true';
        let startTime = isRunning ? Date.now() - elapsedTime : 0;
        let timerInterval;

        function formatTime(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function updateDisplay() {
            document.getElementById("display").innerText = formatTime(elapsedTime);
        }

        function startTimer() {
            isRunning = true;
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplay();
                localStorage.setItem(TIME_KEY, elapsedTime);
            }, 1000);
            localStorage.setItem(RUNNING_KEY, 'true');
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("stopBtn").style.display = "flex";
        }

        function stopTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            localStorage.setItem(RUNNING_KEY, 'false');
            document.getElementById("startBtn").style.display = "flex";
            document.getElementById("stopBtn").style.display = "none";
            saveToHistory();
        }

        function resetTimer() {
            saveToHistory();
            clearInterval(timerInterval);
            elapsedTime = 0;
            isRunning = false;
            localStorage.setItem(TIME_KEY, 0);
            localStorage.setItem(RUNNING_KEY, 'false');
            updateDisplay();
            document.getElementById("startBtn").style.display = "flex";
            document.getElementById("stopBtn").style.display = "none";
        }

        function saveToHistory() {
            if (elapsedTime < 1000) return;
            const date = new Date().toLocaleDateString('ar-EG', { weekday:'long', day:'numeric', month:'long' });
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
            history[date] = formatTime(elapsedTime);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function toggleSheet(show) {
            const sheet = document.getElementById("sheet");
            const overlay = document.getElementById("overlay");
            const list = document.getElementById("logsList");

            if (show) {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
                const entries = Object.entries(history);
                list.innerHTML = entries.length === 0 ? '<div style="text-align:center; padding:40px; opacity:0.4;">لا توجد سجلات</div>' : 
                    entries.reverse().map(([date, time]) => `<div class="history-item"><span>${date}</span><strong>${time}</strong></div>`).join('');
                sheet.classList.add("active");
                overlay.style.display = "block";
            } else {
                sheet.classList.remove("active");
                overlay.style.display = "none";
            }
        }

        setQuote();
        updateDisplay();
        if (isRunning) startTimer();
    </script>
</body>
</html>
